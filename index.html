<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zubi's Homework Shop V30</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'zubi-blue': '#60a5fa',
                        'zubi-green': '#34d399',
                        'zubi-pink': '#fbcfe8',
                        'zubi-yellow': '#fde047',
                        'zubi-purple': '#a855f7',
                        'zubi-gray': '#52525b',
                        'zubi-bg': '#f3f4f6',
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #1f2937;
            transition: background-color 0.5s ease-in-out;
        }
        .container {
            max-width: 1400px;
            width: 95%;
            margin: 2rem auto;
            background-color: #fff;
            border-radius: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 3rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 2fr;
            }
        }
        .panel {
            background-color: #fafafa;
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .message-log {
            min-height: 4rem;
            background-color: #e2e8f0;
            border-radius: 1rem;
            padding: 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            border: 1px solid #cbd5e1;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        .homework-card {
            border: 2px solid #ddd;
            transition: all 0.2s;
        }
        .homework-card.accepted {
            border-color: #3b82f6;
            background-color: #e0f2fe;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .homework-card.in-progress {
            border-color: #4ade80;
            background-color: #f0fdf4;
            animation: pulse 1s infinite alternate;
        }
        @keyframes pulse {
            from {
                transform: scale(1);
            }
            to {
                transform: scale(1.02);
            }
        }
        .homework-card.premium {
            background-color: #fffbeb;
            border-color: #fbbf24;
        }
        .homework-card.charity {
            background-color: #ecfdf5;
            border-color: #34d399;
        }
        .homework-card.rush {
            background-color: #fee2e2;
            border-color: #ef4444;
        }
        .homework-card.group {
            background-color: #e0e7ff;
            border-color: #4f46e5;
        }
        .homework-card.specialty {
            background-color: #f3e8ff;
            border-color: #9333ea;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 1rem;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .progress-bar {
            background-color: #4ade80;
            height: 100%;
            transition: width 0.3s ease;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 2rem;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 600px;
        }
        .cv-card {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        .star-rating {
            color: #fcd34d;
            font-size: 1.5rem;
        }
        .subject-color-math { background-color: #fecaca; }
        .subject-color-science { background-color: #dbeafe; }
        .subject-color-history { background-color: #d1fae5; }
        .subject-color-english { background-color: #fef9c3; }
        .subject-color-finance { background-color: #e5e7eb; }
        .assignment-btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        .assignment-btn:hover {
            background-color: #2563eb;
        }
        .assignment-btn.disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .worker-card {
            background-color: #e2e8f0;
            border: 1px solid #cbd5e1;
            border-radius: 0.75rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .worker-assign-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            background-color: #d1d5db;
            color: #4b5563;
            transition: all 0.2s;
            cursor: pointer;
        }
        .worker-assign-btn:hover:not(.disabled) {
            background-color: #6b7280;
            color: #ffffff;
        }
        .worker-assign-btn.disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Game Stats & Upgrades Panel -->
        <div class="panel flex flex-col items-center p-6 bg-zubi-pink rounded-3xl shadow-lg">
            <h1 class="text-4xl font-bold mb-6 text-zubi-gray text-center">Zubi's Homework Shop</h1>
            <div class="grid grid-cols-2 gap-4 w-full mb-6">
                <div class="card text-center">
                    <p class="text-sm font-medium text-gray-500">Day</p>
                    <p id="day-display" class="text-3xl font-bold">1</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm font-medium text-gray-500">Money</p>
                    <p id="money-display" class="text-3xl font-bold text-zubi-green">£0.00</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm font-medium text-gray-500">Hours Left</p>
                    <p id="zubi-hours-display" class="text-3xl font-bold">12:00</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm font-medium text-gray-500">Completed</p>
                    <p id="completed-display" class="text-3xl font-bold">0</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 w-full mb-6">
                <div class="card text-center">
                    <p class="text-sm font-medium text-gray-500">Zubi's Rating</p>
                    <p id="zubi-rating-display" class="text-3xl font-bold star-rating">★</p>
                </div>
                <div class="card text-center">
                    <p class="text-sm font-medium text-gray-500">Team Rating</p>
                    <p id="team-rating-display" class="text-3xl font-bold star-rating">★</p>
                </div>
            </div>
            
            <div class="w-full mt-4">
                <h3 class="text-xl font-semibold mb-3 text-zubi-gray">Your Inventory</h3>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-center text-sm">
                    <div class="bg-gray-100 p-2 rounded-lg">Textbooks: <span id="textbooks-display" class="font-bold">0</span></div>
                    <div class="bg-gray-100 p-2 rounded-lg">Batteries: <span id="batteries-display" class="font-bold">0</span></div>
                    <div class="bg-gray-100 p-2 rounded-lg">Pens: <span id="pens-display" class="font-bold">0</span></div>
                </div>
            </div>

            <div class="w-full mt-4">
                <h3 class="text-xl font-semibold mb-3 text-zubi-gray">Area: <span id="area-display"></span></h3>
                <h3 class="text-xl font-semibold mb-3 text-zubi-gray">Your Team</h3>
                <div id="employee-list" class="space-y-2">
                    <!-- Employees will be rendered here -->
                </div>
            </div>

            <div class="w-full mt-6">
                <h3 class="text-xl font-semibold mb-3 text-zubi-gray">Upgrades & Supplies</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button id="buy-ad-btn" class="w-full py-3 px-4 bg-zubi-yellow text-gray-800 font-bold rounded-xl shadow-md hover:bg-yellow-400 transition-colors">
                        Buy Advertising
                    </button>
                    <button id="buy-laptop-btn" class="w-full py-3 px-4 bg-zubi-blue text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition-colors">
                        Buy Laptop
                    </button>
                    <button id="search-cvs-btn" class="w-full py-3 px-4 bg-zubi-green text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition-colors">
                        Search CVs
                    </button>
                    <button id="unlock-level-btn" class="w-full py-3 px-4 bg-zubi-purple text-white font-bold rounded-xl shadow-md hover:bg-purple-600 transition-colors">
                        Unlock Next Area
                    </button>
                    <button id="take-course-btn" class="w-full py-3 px-4 bg-indigo-500 text-white font-bold rounded-xl shadow-md hover:bg-indigo-600 transition-colors">
                        Take a Course
                    </button>
                    <button id="buy-textbooks-btn" class="w-full py-3 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-md hover:bg-gray-300 transition-colors">
                        Buy Textbooks
                    </button>
                    <button id="buy-batteries-btn" class="w-full py-3 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-md hover:bg-gray-300 transition-colors">
                        Buy Batteries
                    </button>
                    <button id="buy-pens-btn" class="w-full py-3 px-4 bg-gray-200 text-gray-700 font-bold rounded-xl shadow-md hover:bg-gray-300 transition-colors">
                        Buy Pens
                    </button>
                </div>
            </div>

            <div class="w-full mt-6">
                <h3 class="text-xl font-semibold mb-3 text-zubi-gray">Game Log</h3>
                <p id="message-log" class="message-log">Welcome to the shop!</p>
            </div>
        </div>

        <!-- Homework Queue and Actions Panel -->
        <div class="panel p-6 bg-zubi-bg rounded-3xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-zubi-gray">Daily Clients</h2>
            <div id="potential-clients-list" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <!-- Potential clients will be dynamically added here -->
            </div>

            <h2 class="text-2xl font-bold mt-8 mb-4 text-zubi-gray">Accepted Homework Queue</h2>
            <div id="homework-list" class="mt-4 grid grid-cols-1 gap-4">
                <!-- Homework items will be dynamically added here -->
            </div>

            <div class="mt-8 flex flex-col sm:flex-row justify-between gap-4">
                <button id="end-day-btn" class="flex-grow py-4 px-6 bg-zubi-blue text-white font-bold rounded-xl shadow-md hover:bg-blue-600 transition-colors">
                    End Day
                </button>
                <button id="restart-game-btn" class="py-2 px-4 text-xs text-gray-500 hover:text-red-500 transition-colors">
                    Restart Game
                </button>
                <button id="how-to-play-btn" class="py-2 px-4 text-xs text-gray-500 hover:text-blue-500 transition-colors">
                    How to Play
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="cv-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Search CVs</h2>
            <p class="text-sm text-gray-600 mb-4">Select a candidate to hire for £300.</p>
            <div id="cv-options" class="space-y-4">
                <!-- CVs will be dynamically generated here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button id="close-cv-modal-btn" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
            </div>
        </div>
    </div>
    <div id="event-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h2 id="event-title" class="text-2xl font-bold mb-4"></h2>
            <p id="event-description" class="text-lg text-gray-700"></p>
            <div class="mt-6 flex justify-center">
                <button id="close-event-modal-btn" class="py-2 px-4 bg-zubi-blue text-white rounded-lg hover:bg-blue-600 transition-colors">Okay</button>
            </div>
        </div>
    </div>
    <div id="summary-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4 text-center">End of Day Summary</h2>
            <div class="space-y-3 text-gray-700">
                <p>Day: <span id="summary-day" class="font-bold"></span></p>
                <p>Jobs Completed: <span id="summary-completed" class="font-bold"></span></p>
                <p>Money Earned: <span id="summary-earned" class="font-bold text-green-600"></span></p>
                <p>Penalties: <span id="summary-penalties" class="font-bold text-red-600"></span></p>
                <p>Daily Bills: <span id="summary-bills" class="font-bold text-red-600"></span></p>
                <p>Purchases Made: <span id="summary-purchases" class="font-bold"></span></p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="close-summary-modal-btn" class="py-2 px-4 bg-zubi-blue text-white rounded-lg hover:bg-blue-600 transition-colors">Continue</button>
            </div>
        </div>
    </div>
    <div id="how-to-play-modal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">How to Play</h2>
            <div class="space-y-4 text-gray-700">
                <p>Welcome to Zubi's Homework Shop! Your goal is to grow your business by completing homework assignments and earning money. Here’s how it works:</p>
                <ul class="list-disc list-inside space-y-2">
                    <li><strong>Accepting Jobs:</strong> At the start of each day, new clients will appear. Review their homework details—including the required time, materials, and type—and set a price. Be strategic to get the job!</li>
                    <li><strong>Assigning Work:</strong> Once a job is accepted, it moves to your queue. Assign yourself ("Zubi") or one of your employees to complete the work. Each worker has a different rating that affects their speed.</li>
                    <li><strong>Supplies & Upgrades:</strong> Use your money to buy supplies like textbooks and pens, or invest in upgrades like a laptop or advertising to improve your business.</li>
                    <li><strong>Managing Your Team:</strong> Search for new employees to grow your team. Each employee has a rating.</li>
                </ul>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="close-how-to-play-btn" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Close</button>
            </div>
        </div>
    </div>

    <!-- Restart Confirmation Modals -->
    <div id="restart-confirm-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold mb-4">Warning!</h2>
            <p class="text-lg text-red-600 font-semibold mb-4">Are you sure you want to start this game again from day one and lose all progress?</p>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="restart-confirm-yes-btn" class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">Yes, I'm sure</button>
                <button id="restart-confirm-no-btn" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">No, go back</button>
            </div>
        </div>
    </div>

    <div id="restart-final-modal" class="modal hidden">
        <div class="modal-content text-center">
            <h2 class="text-2xl font-bold mb-4">Final Check!</h2>
            <p class="text-lg text-red-700 font-bold mb-4">Realllly?</p>
            <div class="mt-6 flex justify-center space-x-4">
                <button id="restart-final-yes-btn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Yes, start over</button>
                <button id="restart-final-no-btn" class="py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">No, never mind</button>
            </div>
        </div>
    </div>


    <script>
        window.onload = function() {
            // --- Game State Variables ---
            let day = 1;
            let money = 30.00;
            let textbooks = 10;
            let calcBatteries = 10;
            let pens = 20;
            let homeworksCompleted = 0;
            let homeworkQueue = [];
            let potentialCustomers = [];
            let currentLevel = 1;
            let zubiHoursLeft = 12;

            let employees = [];
            let zubiRating = 1;
            let randomEvent = null;
            let purchasesToday = [];
            let laptopTier = 0;
            let adTier = 0;

            // --- Game Data ---
            const employeeNames = ['ALEX', 'BRENDA', 'CHRIS', 'DANA', 'EVAN', 'FIONA', 'GEORGE', 'HANNAH', 'NATE', 'JESS'];
            const customerNames = ['IMMY', 'IVY', 'KAMSIYONNA', 'AZUBUIKE', 'ZOLA', 'ZARA', 'THALIA', 'ZIKO', 'AIDEN', 'AZARI', 'AZAI', 'TIRENI', 'RIRI', 'JOSEPH', 'MAWUENA', 'BOLU', 'CHIDIMMA', 'KEMI', 'KWAME', 'NALEDI', 'PALESA', 'JOE', 'JANE', 'SARAH'];
            const subjects = ['MATH', 'SCIENCE', 'HISTORY', 'ENGLISH', 'FINANCE'];
            const specialties = ['ZUBI LANGUAGE', 'CALCULUS', 'WORLD HISTORY', 'CREATIVE WRITING', 'DATA ANALYSIS'];
            const recurringExpenses = { rent: 50.00 };
            let suppliesCost = { textbooks: 5, batteries: 2, pens: 1 };
            const courseCost = 100;
            const adCosts = [50, 100, 200, 400, 800];
            const laptopCosts = [500, 1500, 3000];
            const levelUnlockCosts = [1000, 2000, 4000, 8000];
            const areaNames = ['POORVILLE', 'SNOBLAND', 'OLDMONEYTON', 'CORPORATE DISTRICT', 'ACADEMIC CITY'];
            const areaBackgrounds = {
                'POORVILLE': 'bg-zubi-pink',
                'SNOBLAND': 'bg-zubi-yellow',
                'OLDMONEYTON': 'bg-zubi-green',
                'CORPORATE DISTRICT': 'bg-zubi-blue',
                'ACADEMIC CITY': 'bg-zubi-purple'
            };

            const subjectColors = {
                'MATH': 'subject-color-math',
                'SCIENCE': 'subject-color-science',
                'HISTORY': 'subject-color-history',
                'ENGLISH': 'subject-color-english',
                'FINANCE': 'subject-color-finance'
            };
            const homeworkTasksBySubject = {
                'MATH': ['ALGEBRA', 'GEOMETRY', 'CALCULUS', 'STATISTICS'],
                'SCIENCE': ['CHEMISTRY', 'PHYSICS', 'BIOLOGY', 'ASTRONOMY'],
                'HISTORY': ['WORLD WAR II', 'ROMAN EMPIRE', 'ANCIENT GREECE', 'COLD WAR'],
                'ENGLISH': ['ESSAY WRITING', 'POETRY ANALYSIS', 'GRAMMAR', 'CREATIVE STORY'],
                'FINANCE': ['TAX RETURN', 'QUARTERLY REPORT', 'BUDGETING', 'FUNDRAISING']
            };

            // --- DOM Elements ---
            const dayDisplay = document.getElementById('day-display');
            const moneyDisplay = document.getElementById('money-display');
            const completedDisplay = document.getElementById('completed-display');
            const zubiHoursDisplay = document.getElementById('zubi-hours-display');
            const messageLog = document.getElementById('message-log');
            const homeworkList = document.getElementById('homework-list');
            const endDayBtn = document.getElementById('end-day-btn');
            const restartGameBtn = document.getElementById('restart-game-btn');
            const buyTextbooksBtn = document.getElementById('buy-textbooks-btn');
            const buyBatteriesBtn = document.getElementById('buy-batteries-btn');
            const buyPensBtn = document.getElementById('buy-pens-btn');
            const buyAdBtn = document.getElementById('buy-ad-btn');
            const buyLaptopBtn = document.getElementById('buy-laptop-btn');
            const searchCVsBtn = document.getElementById('search-cvs-btn');
            const takeCourseBtn = document.getElementById('take-course-btn');
            const unlockLevelBtn = document.getElementById('unlock-level-btn');
            const areaDisplay = document.getElementById('area-display');
            const zubiRatingDisplay = document.getElementById('zubi-rating-display');
            const teamRatingDisplay = document.getElementById('team-rating-display');
            const cvModal = document.getElementById('cv-modal');
            const cvOptions = document.getElementById('cv-options');
            const closeCvModalBtn = document.getElementById('close-cv-modal-btn');
            const eventModal = document.getElementById('event-modal');
            const eventTitle = document.getElementById('event-title');
            const eventDescription = document.getElementById('event-description');
            const closeEventModalBtn = document.getElementById('close-event-modal-btn');
            const summaryModal = document.getElementById('summary-modal');
            const summaryDay = document.getElementById('summary-day');
            const summaryCompleted = document.getElementById('summary-completed');
            const summaryEarned = document.getElementById('summary-earned');
            const summaryPenalties = document.getElementById('summary-penalties');
            const summaryBills = document.getElementById('summary-bills');
            const summaryPurchases = document.getElementById('summary-purchases');
            const closeSummaryModalBtn = document.getElementById('close-summary-modal-btn');
            const potentialClientsList = document.getElementById('potential-clients-list');
            const employeeList = document.getElementById('employee-list');
            const textbooksDisplay = document.getElementById('textbooks-display');
            const batteriesDisplay = document.getElementById('batteries-display');
            const pensDisplay = document.getElementById('pens-display');
            const howToPlayBtn = document.getElementById('how-to-play-btn');
            const howToPlayModal = document.getElementById('how-to-play-modal');
            const closeHowToPlayBtn = document.getElementById('close-how-to-play-btn');

            // Restart confirmation modal elements
            const restartConfirmModal = document.getElementById('restart-confirm-modal');
            const restartConfirmYesBtn = document.getElementById('restart-confirm-yes-btn');
            const restartConfirmNoBtn = document.getElementById('restart-confirm-no-btn');
            const restartFinalModal = document.getElementById('restart-final-modal');
            const restartFinalYesBtn = document.getElementById('restart-final-yes-btn');
            const restartFinalNoBtn = document.getElementById('restart-final-no-btn');


            let gameInterval;
            const GAME_SPEED = 1000; // 1 second per tick

            // --- Game State Functions ---
            function saveGame() {
                const gameState = {
                    day, money, textbooks, calcBatteries, pens, homeworksCompleted,
                    homeworkQueue, employees, currentLevel, zubiRating, zubiHoursLeft, laptopTier, adTier, purchasesToday
                };
                localStorage.setItem('zubiHomeworkGame', JSON.stringify(gameState));
            }

            function loadGame() {
                const savedState = localStorage.getItem('zubiHomeworkGame');
                if (savedState) {
                    const gameState = JSON.parse(savedState);
                    day = gameState.day;
                    money = gameState.money;
                    textbooks = gameState.textbooks;
                    calcBatteries = gameState.calcBatteries;
                    pens = gameState.pens;
                    homeworksCompleted = gameState.homeworksCompleted;
                    homeworkQueue = gameState.homeworkQueue;
                    employees = gameState.employees || [];
                    zubiRating = gameState.zubiRating || 1;
                    zubiHoursLeft = gameState.zubiHoursLeft || 12;
                    currentLevel = gameState.currentLevel || 1;
                    laptopTier = gameState.laptopTier || 0;
                    adTier = gameState.adTier || 0;
                    purchasesToday = gameState.purchasesToday || [];
                    logMessage("Game loaded from last save.");
                } else {
                    logMessage("Welcome to the shop!");
                    showHowToPlayModal();
                }
            }
            
            function showHowToPlayModal() {
                 howToPlayModal.classList.remove('hidden');
            }

            function resetGame() {
                clearInterval(gameInterval);
                localStorage.removeItem('zubiHomeworkGame');
                window.location.reload();
            }

            function getStarString(rating) {
                const fullStars = '★'.repeat(Math.floor(rating));
                const halfStar = (rating % 1 >= 0.5) ? '½' : '';
                const emptyStars = '☆'.repeat(5 - Math.ceil(rating));
                return fullStars + halfStar + emptyStars;
            }

            function updateUI() {
                dayDisplay.textContent = day;
                moneyDisplay.textContent = `£${money.toFixed(2)}`;
                completedDisplay.textContent = homeworksCompleted;
                zubiHoursDisplay.textContent = `${zubiHoursLeft.toFixed(1)}h`;
                textbooksDisplay.textContent = textbooks;
                batteriesDisplay.textContent = calcBatteries;
                pensDisplay.textContent = pens;

                areaDisplay.textContent = areaNames[currentLevel - 1] || 'MAX LEVEL';
                zubiRatingDisplay.textContent = getStarString(zubiRating);
                const teamRating = employees.length > 0 ? employees.reduce((sum, emp) => sum + emp.rating, 0) / employees.length : 0;
                teamRatingDisplay.textContent = getStarString(teamRating);

                renderPotentialClients();
                renderHomeworkQueue();
                renderEmployees();
                updateShopButtons();
                updateBackground();
                saveGame();
            }

            function renderEmployees() {
                employeeList.innerHTML = '';
                employees.forEach(emp => {
                    const card = document.createElement('div');
                    card.className = 'worker-card';
                    card.innerHTML = `
                        <div class="flex-1">
                            <p class="font-bold">${emp.name}</p>
                            <p class="text-xs text-gray-500">Rating: <span class="star-rating">${getStarString(emp.rating)}</span></p>
                            ${emp.specialty ? `<p class="text-xs text-gray-500">Specialty: ${emp.specialty} (<span class="star-rating">${getStarString(emp.specialtyRating)}</span>)</p>` : ''}
                        </div>
                    `;
                    employeeList.appendChild(card);
                });
            }

            function updateBackground() {
                const areaName = areaNames[currentLevel - 1];
                const newColorClass = areaBackgrounds[areaName] || 'bg-gray-200';
                const body = document.body;
                body.classList.remove(...Object.values(areaBackgrounds));
                body.classList.add(newColorClass);
            }

            function logMessage(message) {
                messageLog.textContent = message;
                saveGame();
            }

            function calculateTime(homework, worker) {
                let timeSpent = homework.timeRequired;

                if (worker) {
                    let rating = worker.rating;
                    if (worker.specialty && worker.specialty === homework.subject) {
                        rating = worker.specialtyRating;
                    }
                    timeSpent = Math.max(0.5, timeSpent * (1 - (rating / 5) * 0.5));
                }

                if (homework.type === 'group') {
                    timeSpent = homework.timeRequired / homework.assignedWorkers.length;
                }

                if (randomEvent && randomEvent.type === 'power_outage') {
                    timeSpent *= 2;
                }
                
                // Tiered laptop bonus
                const laptopBonus = [0, 0.1, 0.2, 0.3];
                if (laptopTier > 0 && randomEvent?.type !== 'computer_virus') {
                     timeSpent *= (1 - laptopBonus[laptopTier]);
                }
                
                // New event: team conflict
                if (randomEvent && randomEvent.type === 'team_conflict' && homework.assignedWorkers.includes(randomEvent.affectedWorker)) {
                    timeSpent *= 1.5;
                }

                return timeSpent;
            }

            function generateNewCustomers() {
                potentialCustomers = [];
                let demand = Math.max(3, 3 + day);

                if (randomEvent && randomEvent.type === 'viral_post') {
                    demand += 5;
                }
                
                if (randomEvent && randomEvent.type === 'new_competitor') {
                    demand = Math.floor(demand * 0.5);
                }

                const shuffledNames = [...customerNames].sort(() => 0.5 - Math.random());
                const namesForToday = shuffledNames.slice(0, demand);

                for (let i = 0; i < demand; i++) {
                    const customerName = namesForToday[i];
                    const id = day + '-' + i;

                    const jobTypeRoll = Math.random();
                    let jobType, homeworkName, grade, difficulty, length, timeRequired, basePrice, effect, subject, penalty, requiredSpecialty, minWorkers, bonus;
                    let textbooksRequired, batteriesRequired, pensRequired;

                    if (jobTypeRoll < 0.05) { // Rush Job
                        jobType = 'rush';
                        subject = subjects[Math.floor(Math.random() * subjects.length)];
                        homeworkName = 'RUSH: ' + homeworkTasksBySubject[subject][Math.floor(Math.random() * homeworkTasksBySubject[subject].length)];
                        grade = ['A*', 'A'][Math.floor(Math.random() * 2)];
                        difficulty = Math.floor(Math.random() * 3) + 3;
                        length = Math.floor(Math.random() * 3) + 3;
                        timeRequired = difficulty + length;
                        const gradeMultiplier = { 'A*': 2, 'A': 1.8 };
                        basePrice = (difficulty * 10 + length * 8) * (gradeMultiplier[grade]) * (1 + (currentLevel - 1) * 0.5);
                        penalty = basePrice * 0.8;
                        effect = 'High Payout, High Penalty';
                    } else if (jobTypeRoll < 0.1) { // Group Project
                        jobType = 'group';
                        subject = subjects[Math.floor(Math.random() * subjects.length)];
                        homeworkName = 'GROUP: ' + homeworkTasksBySubject[subject][Math.floor(Math.random() * homeworkTasksBySubject[subject].length)];
                        grade = 'A*';
                        difficulty = Math.floor(Math.random() * 4) + 4;
                        length = Math.floor(Math.random() * 4) + 4;
                        timeRequired = difficulty + length;
                        basePrice = (difficulty * 8 + length * 6) * (1 + (currentLevel - 1) * 0.5);
                        minWorkers = 2;
                        bonus = basePrice * 0.2;
                        effect = 'Requires multiple workers';
                    } else if (jobTypeRoll < 0.15) { // Specialty Job
                        jobType = 'specialty';
                        const specialtyRoll = Math.random();
                        if (specialtyRoll < 0.5) {
                            requiredSpecialty = 'ZUBI LANGUAGE';
                        } else {
                            requiredSpecialty = specialties[Math.floor(Math.random() * specialties.length)];
                        }
                        subject = subjects[Math.floor(Math.random() * subjects.length)];
                        homeworkName = `SPECIALTY: ${requiredSpecialty}`;
                        grade = 'A*';
                        difficulty = Math.floor(Math.random() * 5) + 1;
                        length = Math.floor(Math.random() * 5) + 1;
                        timeRequired = difficulty + length;
                        basePrice = (difficulty * 6 + length * 5) * (1 + (currentLevel - 1) * 0.5) * 2;
                        effect = 'Requires specific skill';
                    } else if (jobTypeRoll < 0.25) { // Premium Job
                        jobType = 'premium';
                        subject = 'FINANCE';
                        homeworkName = homeworkTasksBySubject[subject][Math.floor(Math.random() * homeworkTasksBySubject[subject].length)];
                        grade = 'A*';
                        difficulty = Math.floor(Math.random() * 3) + 3;
                        length = Math.floor(Math.random() * 3) + 3;
                        timeRequired = difficulty + length;
                        basePrice = (difficulty * 10 + length * 8) * (1 + (currentLevel - 1) * 0.5);
                        effect = 'High Payout';
                    } else if (jobTypeRoll < 0.4) { // Charity Job
                        jobType = 'charity';
                        const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
                        subject = randomSubject;
                        homeworkName = homeworkTasksBySubject[subject][Math.floor(Math.random() * homeworkTasksBySubject[subject].length)];
                        grade = 'N/A';
                        difficulty = Math.floor(Math.random() * 2) + 1;
                        length = Math.floor(Math.random() * 2) + 1;
                        timeRequired = difficulty + length;
                        basePrice = (difficulty * 1 + length * 1);
                        effect = 'Boosts Advertising';
                    } else { // Standard Student Job
                        jobType = 'student';
                        const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
                        subject = randomSubject;
                        homeworkName = homeworkTasksBySubject[subject][Math.floor(Math.random() * homeworkTasksBySubject[subject].length)];
                        grade = ['A*', 'A', 'B'][Math.floor(Math.random() * 3)];
                        difficulty = Math.floor(Math.random() * 5) + 1;
                        length = Math.floor(Math.random() * 5) + 1;
                        timeRequired = difficulty + length;
                        const gradeMultiplier = { 'A*': 1.8, 'A': 1.5, 'B': 1.2 };
                        basePrice = (difficulty * 5 + length * 3) * (gradeMultiplier[grade]) * (1 + (currentLevel - 1) * 0.5);
                        effect = 'Standard Job';
                    }
                    if (randomEvent && randomEvent.type === 'viral_post') {
                         basePrice *= 1.5;
                    }
                    if (randomEvent && randomEvent.type === 'new_competitor') {
                        basePrice *= 0.7;
                    }

                    textbooksRequired = Math.floor(difficulty);
                    batteriesRequired = Math.floor(Math.random() * difficulty) + 1;
                    pensRequired = Math.floor(length);

                    potentialCustomers.push({ id, customerName, homeworkName, grade, difficulty, length, timeRequired, basePrice, type: jobType, effect: effect, subject, textbooksRequired, batteriesRequired, pensRequired, penalty, requiredSpecialty, minWorkers, bonus, deadline: day + 1 });
                }
                logMessage(`DAY ${day}: ${demand} new clients arrived. Review their requests!`);
                renderPotentialClients();
            }

            function renderPotentialClients() {
                potentialClientsList.innerHTML = '';
                if (potentialCustomers.length === 0) {
                    potentialClientsList.innerHTML = '<p class="text-center text-gray-500 col-span-2">No more clients waiting.</p>';
                }

                potentialCustomers.forEach(customer => {
                    const card = document.createElement('div');
                    let colorClass = customer.type === 'premium' ? 'homework-card premium' :
                                     customer.type === 'charity' ? 'homework-card charity' :
                                     customer.type === 'rush' ? 'homework-card rush' :
                                     customer.type === 'group' ? 'homework-card group' :
                                     customer.type === 'specialty' ? 'homework-card specialty' :
                                     `homework-card ${subjectColors[customer.subject]}`;

                    card.className = `${colorClass} p-4 rounded-lg shadow-md`;
                    card.innerHTML = `
                        <h3 class="font-bold text-lg">${customer.customerName}</h3>
                        <p class="text-sm font-medium text-gray-600">${customer.subject} - ${customer.homeworkName}</p>
                        <p class="text-xs text-gray-500">Type: ${customer.type.toUpperCase()}</p>
                        ${customer.type === 'specialty' ? `<p class="text-xs text-purple-600 font-bold">Requires: ${customer.requiredSpecialty}</p>` : ''}
                        ${customer.type === 'rush' ? `<p class="text-xs text-red-600 font-bold">Penalty: £${customer.penalty.toFixed(2)}</p>` : ''}
                        ${customer.type === 'group' ? `<p class="text-xs font-bold text-indigo-600">Requires: ${customer.minWorkers} WORKERS</p>` : ''}
                        <p class="text-xs text-gray-500">Est. Time: ${customer.timeRequired.toFixed(1)}h</p>
                        <div class="mt-2 text-xs">
                            <p class="font-medium text-gray-700">Materials Needed:</p>
                            <ul class="list-disc list-inside text-gray-600">
                                <li>Textbooks: ${customer.textbooksRequired}</li>
                                <li>Batteries: ${customer.batteriesRequired}</li>
                                <li>Pens: ${customer.pensRequired}</li>
                            </ul>
                        </div>
                        <div class="mt-4 flex items-center space-x-2">
                            <label for="quote-input-${customer.id}" class="text-xs font-medium text-gray-700">Quote (£):</label>
                            <input type="number" id="quote-input-${customer.id}" value="${customer.basePrice.toFixed(2)}" min="0.01" step="0.01" class="w-24 p-1 border border-gray-300 rounded-lg text-center text-xs">
                        </div>
                        <button class="mt-4 w-full py-2 px-4 bg-zubi-green text-white font-bold rounded-xl hover:bg-green-600 transition-colors accept-quote-btn" data-id="${customer.id}">Accept Quote</button>
                    `;
                    potentialClientsList.appendChild(card);
                });

                document.querySelectorAll('.accept-quote-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        const customer = potentialCustomers.find(c => c.id === id);
                        const quote = parseFloat(document.getElementById(`quote-input-${id}`).value);
                        acceptQuote(customer, quote);
                    });
                });
            }

            function acceptQuote(customer, quote) {
                if (textbooks < customer.textbooksRequired || calcBatteries < customer.batteriesRequired || pens < customer.pensRequired) {
                    logMessage(`Not enough supplies! You need ${customer.textbooksRequired - textbooks} more textbooks, ${customer.batteriesRequired - calcBatteries} more batteries, and ${customer.pensRequired - pens} more pens.`);
                    return;
                }

                const baseAcceptanceRate = 0.5;
                const priceFactor = 1.5;
                const levelFactor = 0.1;
                const reputationFactor = zubiRating * 0.1;

                const acceptanceChance = Math.random() + (customer.basePrice / quote) * priceFactor + (currentLevel * levelFactor) + reputationFactor - (quote / customer.basePrice) * 0.5;

                if (acceptanceChance > baseAcceptanceRate) {
                    textbooks -= customer.textbooksRequired;
                    calcBatteries -= customer.batteriesRequired;
                    pens -= customer.pensRequired;

                    const acceptedHomework = { ...customer, agreedPrice: quote, status: 'waiting', assignedWorkers: [], progress: 0, timeSpent: 0 };
                    homeworkQueue.push(acceptedHomework);
                    logMessage(`${customer.customerName} accepts your offer of £${quote.toFixed(2)}! SUPPLIES USED. HOMEWORK ADDED TO QUEUE.`);
                    potentialCustomers = potentialCustomers.filter(c => c.id !== customer.id);
                    updateUI(); // Re-render the UI to show changes
                } else {
                    logMessage(`${customer.customerName} rejects your offer and leaves.`);
                    potentialCustomers = potentialCustomers.filter(c => c.id !== customer.id);
                    updateUI(); // Re-render the UI to show changes
                }
            }
            
            function startGameLoop() {
                clearInterval(gameInterval);
                gameInterval = setInterval(() => {
                    // Update progress for all assigned homeworks
                    homeworkQueue.forEach(hw => {
                        if (hw.assignedWorkers.length > 0) {
                            const totalWorkRate = hw.assignedWorkers.reduce((sum, workerName) => {
                                const worker = employees.find(emp => emp.name === workerName) || { name: 'ZUBI', rating: zubiRating, specialty: 'ALL', specialtyRating: zubiRating };
                                return sum + (1 / calculateTime(hw, worker));
                            }, 0);
                            hw.progress += totalWorkRate * (GAME_SPEED / 1000);
                        }
                    });
                    renderHomeworkQueue();
                }, GAME_SPEED);
            }

            function renderHomeworkQueue() {
                homeworkList.innerHTML = '';
                if (homeworkQueue.length === 0) {
                    homeworkList.innerHTML = '<p class="text-center text-gray-500">NO HOMEWORKS IN QUEUE. ACCEPT A JOB TO GET STARTED.</p>';
                }

                const workersAssignedToday = homeworkQueue.filter(h => h.type !== 'group').map(h => h.assignedWorkers[0]).filter(Boolean);
                const allWorkers = [{ name: 'ZUBI', rating: zubiRating, specialty: 'ALL' }, ...employees];

                homeworkQueue.forEach(hw => {
                    const card = document.createElement('div');
                    card.className = `homework-card card p-4`;
                    
                    if (hw.assignedWorkers.length > 0) {
                        card.classList.add('in-progress');
                    } else {
                         card.classList.add('accepted');
                    }
                    
                    let colorClass = hw.type === 'premium' ? 'premium' :
                                     hw.type === 'charity' ? 'charity' :
                                     hw.type === 'rush' ? 'rush' :
                                     hw.type === 'group' ? 'group' :
                                     hw.type === 'specialty' ? 'specialty' :
                                     subjectColors[hw.subject];
                    card.classList.add(colorClass);

                    const assignContainer = document.createElement('div');
                    if (hw.assignedWorkers.length > 0 && hw.type !== 'group') {
                        assignContainer.innerHTML = `<p class="text-xs font-semibold text-gray-700">ASSIGNED TO:</p><p class="text-sm font-bold">${hw.assignedWorkers.join(', ')}</p>`;
                    } else if (hw.type === 'group' && hw.assignedWorkers.length >= hw.minWorkers) {
                        assignContainer.innerHTML = `<p class="text-xs font-semibold text-gray-700">ASSIGNED TO:</p><p class="text-sm font-bold">${hw.assignedWorkers.join(', ')}</p>`;
                    } else {
                        // New button-based assignment
                        const workerButtonsContainer = document.createElement('div');
                        workerButtonsContainer.className = 'mt-2 flex flex-wrap gap-2';

                        allWorkers.forEach(worker => {
                            let isDisabled = false;
                            if (hw.type !== 'group' && workersAssignedToday.includes(worker.name)) {
                                isDisabled = true;
                            }
                            if (hw.type === 'specialty' && worker.specialty !== hw.requiredSpecialty) {
                                isDisabled = true;
                            }
                            if (hw.assignedWorkers.includes(worker.name)) {
                                isDisabled = true;
                            }

                            const workerBtn = document.createElement('button');
                            workerBtn.className = `worker-assign-btn ${isDisabled ? 'disabled' : ''}`;
                            workerBtn.textContent = worker.name;
                            workerBtn.disabled = isDisabled;

                            if (!isDisabled) {
                                workerBtn.addEventListener('click', () => {
                                    assignWorker(hw.id, worker.name);
                                });
                            }
                            workerButtonsContainer.appendChild(workerBtn);
                        });
                        assignContainer.appendChild(workerButtonsContainer);
                    }
                    
                    const progressBarContainer = document.createElement('div');
                    progressBarContainer.className = 'progress-bar-container';
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${Math.min(100, (hw.progress / hw.timeRequired) * 100)}%`;
                    progressBarContainer.appendChild(progressBar);

                    card.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-bold text-lg">${hw.customerName}</h4>
                                <p class="text-sm text-gray-600">${hw.homeworkName}</p>
                            </div>
                            <p class="font-semibold text-xl text-zubi-green">£${hw.agreedPrice.toFixed(2)}</p>
                        </div>
                        <div class="mt-2 text-xs text-gray-500 flex justify-between">
                            <p>Required: ${hw.timeRequired.toFixed(1)}h</p>
                            <p>Deadline: Day ${hw.deadline}</p>
                        </div>
                        <div class="mt-4">
                           ${assignContainer.outerHTML}
                        </div>
                        <div class="mt-4">
                            <p class="text-xs font-medium text-gray-700">Progress: ${Math.min(100, (hw.progress/hw.timeRequired*100)).toFixed(0)}%</p>
                            ${progressBarContainer.outerHTML}
                        </div>
                    `;
                    homeworkList.appendChild(card);
                });
            }

            function assignWorker(homeworkId, workerName) {
                const homework = homeworkQueue.find(hw => hw.id === homeworkId);
                const worker = employees.find(emp => emp.name === workerName) || { name: 'ZUBI', rating: zubiRating, specialty: 'ALL', specialtyRating: zubiRating };

                if (workerName === 'ZUBI') {
                    if (zubiHoursLeft <= 0) {
                        logMessage(`ZUBI doesn't have enough hours left. CHOOSE ANOTHER WORKER OR END THE DAY.`);
                        return;
                    }
                } else {
                    const employee = employees.find(emp => emp.name === workerName);
                    if (homeworkQueue.find(h => h.assignedWorkers.includes(employee.name) && h.type !== 'group')) {
                        logMessage(`${worker.name} IS ALREADY ASSIGNED A JOB FOR THE DAY.`);
                        return;
                    }
                }

                if (homework.type === 'specialty' && worker.specialty !== homework.requiredSpecialty) {
                    logMessage(`${worker.name} DOES NOT HAVE THE REQUIRED SPECIALTY FOR THIS JOB.`);
                    return;
                }
                
                homework.assignedWorkers.push(worker.name);
                logMessage(`${worker.name} HAS BEEN ASSIGNED TO ${homework.homeworkName}.`);
                updateUI();
            }

            function updateShopButtons() {
                const laptopCost = laptopCosts[laptopTier];
                const adCost = adCosts[adTier];
                
                buyLaptopBtn.textContent = laptopTier < laptopCosts.length ? `BUY LAPTOP TIER ${laptopTier + 1} (£${laptopCost.toFixed(2)})` : 'MAX LAPTOP TIER';
                buyLaptopBtn.disabled = laptopTier >= laptopCosts.length || money < laptopCost;
                buyLaptopBtn.classList.toggle('opacity-50', buyLaptopBtn.disabled);
                buyLaptopBtn.classList.toggle('cursor-not-allowed', buyLaptopBtn.disabled);
                
                buyAdBtn.textContent = adTier < adCosts.length ? `BUY ADVERTISING TIER ${adTier + 1} (£${adCost.toFixed(2)})` : 'MAX ADVERTISING TIER';
                buyAdBtn.disabled = adTier >= adCosts.length || money < adCost;
                buyAdBtn.classList.toggle('opacity-50', buyAdBtn.disabled);
                buyAdBtn.classList.toggle('cursor-not-allowed', buyAdBtn.disabled);

                buyTextbooksBtn.textContent = `BUY TEXTBOOKS (£${suppliesCost.textbooks.toFixed(2)})`;
                buyBatteriesBtn.textContent = `BUY BATTERIES (£${suppliesCost.batteries.toFixed(2)})`;
                buyPensBtn.textContent = `BUY PENS (£${suppliesCost.pens.toFixed(2)})`;
                searchCVsBtn.textContent = `SEARCH CVs (£50)`;
                takeCourseBtn.textContent = `TAKE A COURSE (£${courseCost.toFixed(2)})`;

                const buyButtons = [
                    { btn: buyTextbooksBtn, cost: suppliesCost.textbooks },
                    { btn: buyBatteriesBtn, cost: suppliesCost.batteries },
                    { btn: buyPensBtn, cost: suppliesCost.pens },
                    { btn: searchCVsBtn, cost: 50 },
                    { btn: takeCourseBtn, cost: courseCost },
                ];

                buyButtons.forEach(item => {
                    const canAfford = money >= item.cost;
                    item.btn.disabled = !canAfford;
                    item.btn.classList.toggle('opacity-50', !canAfford);
                    item.btn.classList.toggle('cursor-not-allowed', !canAfford);
                });

                const unlockCost = levelUnlockCosts[currentLevel - 1];
                const canUnlock = money >= unlockCost && currentLevel <= areaNames.length;
                unlockLevelBtn.disabled = !canUnlock;
                unlockLevelBtn.classList.toggle('opacity-50', !canUnlock);
                unlockLevelBtn.classList.toggle('cursor-not-allowed', !canUnlock);
                if (currentLevel > areaNames.length) {
                    unlockLevelBtn.textContent = "MAX LEVEL REACHED";
                } else {
                    unlockLevelBtn.textContent = `UNLOCK NEXT AREA (£${unlockCost.toFixed(2)})`;
                }
            }

            function processDayWork() {
                let totalEarnings = 0;
                let totalPenalties = 0;
                let completedJobs = 0;
                let purchasesSummary = purchasesToday.join(', ');

                money -= recurringExpenses.rent;
                let dailyBills = recurringExpenses.rent;
                
                // Iterate through a copy of the queue to safely modify the original
                const completedHomeworks = [];
                const failedHomeworks = [];

                homeworkQueue.forEach(hw => {
                    // Check if job is completed
                    if (hw.progress >= hw.timeRequired) {
                        let earned = hw.agreedPrice;
                        let penalty = 0;

                        // Apply penalties/bonuses based on type
                        if (hw.type === 'rush' && day >= hw.deadline) {
                            penalty += hw.penalty;
                        } else if (hw.type === 'group' && hw.assignedWorkers.length < hw.minWorkers) {
                            penalty += hw.agreedPrice * 0.5;
                        } else if (hw.type === 'group' && hw.assignedWorkers.length >= hw.minWorkers) {
                            earned += hw.bonus;
                        }
                        
                        // Check for charity job bonus
                        if (hw.type === 'charity') {
                           zubiRating = Math.min(5, zubiRating + 0.1);
                        }

                        if (penalty > 0) {
                            totalPenalties += penalty;
                            logMessage(`Job for ${hw.customerName} failed due to penalty! Penalty: £${penalty.toFixed(2)}`);
                            failedHomeworks.push(hw);
                        } else {
                            totalEarnings += earned;
                            completedJobs++;
                            logMessage(`Job for ${hw.customerName} completed! Earned: £${earned.toFixed(2)}`);
                            completedHomeworks.push(hw);
                        }

                    } else {
                        // Job not completed on time
                        const penalty = hw.agreedPrice * 0.5;
                        totalPenalties += penalty;
                        logMessage(`Job for ${hw.customerName} failed to complete. Penalty: £${penalty.toFixed(2)}`);
                        failedHomeworks.push(hw);
                    }
                });
                
                // Update game state
                money += totalEarnings - totalPenalties;
                homeworksCompleted += completedJobs;

                // Clear the homework queue
                homeworkQueue = [];

                // Show summary
                showSummary(completedJobs, totalEarnings, totalPenalties, dailyBills, purchasesSummary);
            }

            function showSummary(completed, earned, penalties, bills, purchases) {
                summaryDay.textContent = day;
                summaryCompleted.textContent = completed;
                summaryEarned.textContent = `£${earned.toFixed(2)}`;
                summaryPenalties.textContent = `£${penalties.toFixed(2)}`;
                summaryBills.textContent = `£${bills.toFixed(2)}`;
                summaryPurchases.textContent = purchases || 'NONE';
                summaryModal.classList.remove('hidden');
                clearInterval(gameInterval);
            }

            function startNewDay() {
                day++;
                zubiHoursLeft = 12;
                homeworkQueue = [];
                potentialCustomers = [];
                purchasesToday = [];
                suppliesCost = { textbooks: 5, batteries: 2, pens: 1 };
                checkRandomEvent();
                generateNewCustomers();
                updateUI();
                startGameLoop();
            }

            // --- Event Listeners ---
            endDayBtn.addEventListener('click', () => {
                processDayWork();
            });

            closeSummaryModalBtn.addEventListener('click', () => {
                summaryModal.classList.add('hidden');
                startNewDay();
            });

            buyTextbooksBtn.addEventListener('click', () => {
                const cost = suppliesCost.textbooks;
                if (money >= cost) {
                    money -= cost;
                    textbooks += 10;
                    purchasesToday.push(`10 Textbooks (£${cost.toFixed(2)})`);
                    logMessage(`YOU BOUGHT 10 TEXTBOOKS FOR £${cost.toFixed(2)}.`);
                    updateUI();
                } else {
                    logMessage("NOT ENOUGH MONEY TO BUY TEXTBOOKS.");
                }
            });

            buyBatteriesBtn.addEventListener('click', () => {
                const cost = suppliesCost.batteries;
                if (money >= cost) {
                    money -= cost;
                    calcBatteries += 10;
                    purchasesToday.push(`10 Batteries (£${cost.toFixed(2)})`);
                    logMessage(`YOU BOUGHT 10 CALCULATOR BATTERIES FOR £${cost.toFixed(2)}.`);
                    updateUI();
                } else {
                    logMessage("NOT ENOUGH MONEY TO BUY BATTERIES.");
                }
            });

            buyPensBtn.addEventListener('click', () => {
                const cost = suppliesCost.pens;
                if (money >= cost) {
                    money -= cost;
                    pens += 10;
                    purchasesToday.push(`10 Pens (£${cost.toFixed(2)})`);
                    logMessage(`YOU BOUGHT 10 PENS FOR £${cost.toFixed(2)}.`);
                    updateUI();
                } else {
                    logMessage("NOT ENOUGH MONEY TO BUY PENS.");
                }
            });

            buyAdBtn.addEventListener('click', () => {
                const adCost = adCosts[adTier];
                if (adTier < adCosts.length && money >= adCost) {
                    money -= adCost;
                    adTier++;
                    const adBonus = [0.2, 0.5, 0.8, 1.2, 1.5];
                    zubiRating = Math.min(5, zubiRating + adBonus[adTier - 1]);
                    purchasesToday.push(`ADVERTISING TIER ${adTier} (£${adCost.toFixed(2)})`);
                    logMessage(`ADVERTISING TIER INCREASED! YOUR RATING IS NOW ${zubiRating.toFixed(2)} STARS.`);
                    updateUI();
                } else if (adTier >= adCosts.length) {
                    logMessage(`YOU'VE REACHED THE MAXIMUM ADVERTISING TIER.`);
                } else {
                    logMessage(`NOT ENOUGH MONEY FOR ADVERTISING. YOU NEED £${adCost.toFixed(2)}.`);
                }
            });

            buyLaptopBtn.addEventListener('click', () => {
                const upgradeCost = laptopCosts[laptopTier];
                if (laptopTier < laptopCosts.length && money >= upgradeCost) {
                    money -= upgradeCost;
                    laptopTier++;
                    const laptopBonus = [0, 10, 20, 30];
                    purchasesToday.push(`LAPTOP TIER ${laptopTier} (£${upgradeCost.toFixed(2)})`);
                    logMessage(`YOU BOUGHT A LAPTOP UPGRADE! HOMEWORK COMPLETION TIME IS NOW REDUCED BY ${laptopBonus[laptopTier]}%.`);
                    updateUI();
                } else if (laptopTier >= laptopCosts.length) {
                    logMessage('YOU HAVE THE BEST LAPTOP!');
                } else {
                    logMessage(`NOT ENOUGH MONEY TO BUY THE LAPTOP. YOU NEED £${upgradeCost.toFixed(2)}.`);
                }
            });

            searchCVsBtn.addEventListener('click', () => {
                if (money >= 50) {
                    money -= 50;
                    purchasesToday.push(`CV SEARCH (£50.00)`);
                    logMessage('YOU PAID £50 TO SEARCH FOR NEW EMPLOYEES.');
                    showCVs();
                } else {
                    logMessage('NOT ENOUGH MONEY TO SEARCH FOR EMPLOYEES.');
                }
            });

            takeCourseBtn.addEventListener('click', () => {
                if (employees.length === 0) {
                    logMessage('YOU NEED TO HIRE EMPLOYEES BEFORE YOU CAN TAKE A COURSE TO IMPROVE YOUR PERSONAL RATING!');
                    return;
                }

                if (money >= courseCost) {
                    const teamRating = employees.reduce((sum, emp) => sum + emp.rating, 0) / employees.length;
                    money -= courseCost;
                    zubiRating = Math.min(5, zubiRating + teamRating * 0.1);
                    purchasesToday.push(`COURSE (£${courseCost.toFixed(2)})`);
                    logMessage(`YOU TOOK A COURSE AND IMPROVED YOUR PERSONAL RATING! YOUR RATING IS NOW ${zubiRating.toFixed(2)} STARS.`);
                } else {
                    logMessage(`NOT ENOUGH MONEY TO TAKE A COURSE. YOU NEED £${courseCost.toFixed(2)}.`);
                }
                updateUI();
            });

            unlockLevelBtn.addEventListener('click', () => {
                const unlockCost = levelUnlockCosts[currentLevel - 1];
                if (currentLevel > areaNames.length) {
                    logMessage('YOU ARE ALREADY AT THE MAX LEVEL!');
                    return;
                }

                if (money >= unlockCost) {
                    money -= unlockCost;
                    currentLevel++;
                    purchasesToday.push(`NEW AREA UNLOCK (£${unlockCost.toFixed(2)})`);
                    logMessage(`YOU HAVE UNLOCKED A NEW AREA: ${areaNames[currentLevel - 1]}. CUSTOMERS WILL PAY MORE!`);
                } else {
                    logMessage(`NOT ENOUGH MONEY TO UNLOCK THE NEXT AREA. YOU NEED £${unlockCost.toFixed(2)}.`);
                }
                updateUI();
            });

            // Restart button event listener now shows the first confirmation modal
            restartGameBtn.addEventListener('click', () => {
                restartConfirmModal.classList.remove('hidden');
            });

            // First confirmation 'Yes' button
            restartConfirmYesBtn.addEventListener('click', () => {
                restartConfirmModal.classList.add('hidden');
                restartFinalModal.classList.remove('hidden');
            });

            // First confirmation 'No' button
            restartConfirmNoBtn.addEventListener('click', () => {
                restartConfirmModal.classList.add('hidden');
            });

            // Final confirmation 'Yes' button
            restartFinalYesBtn.addEventListener('click', () => {
                restartFinalModal.classList.add('hidden');
                resetGame();
            });

            // Final confirmation 'No' button
            restartFinalNoBtn.addEventListener('click', () => {
                restartFinalModal.classList.add('hidden');
            });

            closeCvModalBtn.addEventListener('click', () => {
                cvModal.classList.add('hidden');
            });

            closeEventModalBtn.addEventListener('click', () => {
                eventModal.classList.add('hidden');
            });
            
            howToPlayBtn.addEventListener('click', () => {
                howToPlayModal.classList.remove('hidden');
            });
            
            closeHowToPlayBtn.addEventListener('click', () => {
                howToPlayModal.classList.add('hidden');
            });

            function showCVs() {
                cvOptions.innerHTML = '';
                cvModal.classList.remove('hidden');

                const numCVs = Math.floor(Math.random() * 3) + 1;
                for (let i = 0; i < numCVs; i++) {
                    const specialtySubject = specialties[Math.floor(Math.random() * specialties.length)];
                    const employee = {
                        id: `emp-${Date.now()}-${i}`,
                        name: employeeNames[Math.floor(Math.random() * employeeNames.length)],
                        rating: Math.floor(Math.random() * 5) + 1,
                        specialty: specialtySubject,
                        specialtyRating: Math.min(5, Math.floor(Math.random() * 3) + 3),
                        maxHours: Math.floor(Math.random() * 7) + 4
                    };

                    const card = document.createElement('div');
                    card.className = 'cv-card';
                    card.innerHTML = `
                        <p class="font-bold text-lg">${employee.name}</p>
                        <p class="text-sm">Rating: <span class="star-rating">${getStarString(employee.rating)}</span></p>
                        <p class="text-sm">Specialty: ${employee.specialty} (<span class="star-rating">${getStarString(employee.specialtyRating)}</span>)</p>
                        <p class="text-sm">Hours Available: ${employee.maxHours}h</p>
                        <p class="text-xs mt-2 text-gray-500">HIRE FOR £300</p>
                    `;
                    const hireBtn = document.createElement('button');
                    hireBtn.className = 'py-2 px-4 mt-2 bg-zubi-green text-white rounded-lg text-sm hover:bg-green-700 transition-colors';
                    hireBtn.textContent = 'HIRE';
                    hireBtn.addEventListener('click', () => hireEmployee(employee));
                    card.appendChild(hireBtn);
                    cvOptions.appendChild(card);
                }
            }

            function hireEmployee(employee) {
                if (money >= 300) {
                    money -= 300;
                    employees.push(employee);
                    cvModal.classList.add('hidden');
                    purchasesToday.push(`HIRING ${employee.name} (£300.00)`);
                    logMessage(`YOU HIRED ${employee.name}! THEY ARE NOW PART OF YOUR TEAM.`);
                    updateUI();
                } else {
                    logMessage('NOT ENOUGH MONEY TO HIRE THIS EMPLOYEE!');
                }
            }

            function checkRandomEvent() {
                const eventChance = Math.random();
                let eventTitleText = '';
                let eventDescriptionText = '';
                randomEvent = null; // Reset event from previous day

                if (eventChance < 0.1) {
                    eventTitleText = 'POWER OUTAGE!';
                    eventDescriptionText = 'A POWER OUTAGE HAS DOUBLED THE TIME IT TAKES TO COMPLETE ALL HOMEWORK TODAY.';
                    randomEvent = { type: 'power_outage' };
                } else if (eventChance < 0.2) {
                    eventTitleText = 'SUPPLY SHORTAGE!';
                    const affectedSupply = ['textbooks', 'batteries', 'pens'][Math.floor(Math.random() * 3)];
                    suppliesCost[affectedSupply] *= 3;
                    eventDescriptionText = `A CITY-WIDE ${affectedSupply.toUpperCase()} SHORTAGE HAS TRIPLED THE COST FOR TODAY.`;
                    randomEvent = { type: 'supply_shortage', affectedSupply };
                } else if (eventChance < 0.3) {
                    eventTitleText = 'VIRAL POST!';
                    eventDescriptionText = 'A STUDENT POSTED ABOUT YOUR SHOP ONLINE! YOU HAVE A HUGE INFLUX OF CUSTOMERS AND HIGHER PRICES TODAY.';
                    randomEvent = { type: 'viral_post' };
                } else if (eventChance < 0.4 && laptopTier > 0) {
                    eventTitleText = 'COMPUTER VIRUS!';
                    eventDescriptionText = 'YOUR LAPTOP HAS A VIRUS, RENDERING IT UNUSABLE FOR THE DAY. ITS BONUS IS GONE.';
                    randomEvent = { type: 'computer_virus' };
                } else if (eventChance < 0.5 && employees.length > 0) {
                    const affectedWorker = employees[Math.floor(Math.random() * employees.length)].name;
                    eventTitleText = 'TEAM CONFLICT!';
                    eventDescriptionText = `${affectedWorker} IS IN A FIGHT WITH ANOTHER WORKER AND IS SLOWED DOWN TODAY.`;
                    randomEvent = { type: 'team_conflict', affectedWorker };
                } else if (eventChance < 0.6) {
                    eventTitleText = 'NEW COMPETITOR!';
                    eventDescriptionText = 'A NEW HOMEWORK SHOP OPENED! ALL PRICES ARE REDUCED FOR THE DAY.';
                    randomEvent = { type: 'new_competitor' };
                } else {
                    randomEvent = null;
                }
                
                if (randomEvent) {
                    eventTitle.textContent = eventTitleText;
                    eventDescription.textContent = eventDescriptionText;
                    eventModal.classList.remove('hidden');
                }
            }

            // Initial game setup
            loadGame();
            if (homeworkQueue.length === 0 && day === 1) {
                checkRandomEvent();
                generateNewCustomers();
            } else if (homeworkQueue.length === 0) {
                logMessage('GAME LOADED. READY TO FINISH THE DAY OR START A NEW ONE.');
            }
            updateUI();
            startGameLoop();
        };
    </script>
</body>
</html>
